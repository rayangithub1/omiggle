<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Keep existing head content the same -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat App</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <script src="/socket.io/socket.io.js"></script>

  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #fff7ee;
      color: #333;
    }

    /* HEADER */
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #fff;
      padding: 7px 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,.1);
    }

    .logo {
      height: 55px;
    }

    .online-users {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: bold;
    }

    .status-dot {
      color: #28a745;
    }

    /* SCROLLING BANNER */
    #scrollingBanner {
      background: #fff3cd;
      color: #856404;
      padding: 12px;
      overflow: hidden;
      text-align: center;
    }

    .scrolling-text {
      white-space: nowrap;
      animation: scrollText 15s linear infinite;
    }

    @keyframes scrollText {
      0% {
        transform: translateX(100%);
      }

      100% {
        transform: translateX(-100%);
      }
    }

    /* MODAL */
    #nameModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .modal-content {
      background: #fff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
      width: 90%;
      max-width: 400px;
    }

    .modal-content input,
    .modal-content button {
      width: 100%;
      padding: 10px;
      margin-bottom: 12px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 16px;
    }

    /* CHAT CONTAINER */
    #chatContainer {
      display: flex;
      flex-wrap: wrap;
      padding: 10px;
    }

    #leftColumn,
    #rightColumn {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 10px;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.05);
      padding: 20px;
      margin-bottom: 20px;
    }

    @media (min-width: 768px) {
      #leftColumn,
      #rightColumn {
        margin: 5px;
      }
    }

    #leftColumn {
      flex: 1;
      max-width: 100%;
    }

    #rightColumn {
  flex: 2;
  max-width: 70%;
  display: flex;
  flex-direction: column;
  height: calc(100vh - 100px); /* Header height is 80px */
  position: relative;
  background-color: #ffffff;
}

#messages {
  flex: 1;
  overflow-y: auto;
  padding: 1rem;
}




    #rightColumn h2 {
      font-size: 22px;
      font-weight: bold;
      margin-bottom: 15px;
    }

    #rightColumn ul {
      padding-left: 20px;
      font-size: 17px;
      font-weight: bold;
      color: #000;
      margin-bottom: 20px;
    }

    #rightColumn ul li {
      margin-bottom: 8px;
    }

    #welcomeMessage {
      background: #eaf7ff;
      padding: 12px;
      border-radius: 8px;
      color: #007bff;
      font-weight: 500;
      margin-bottom: 10px;
    }

    
#inputContainer {
  padding: 1rem;
  background-color: #fff;
  border-top: 1px solid #ccc;
  position: sticky;
  bottom: 0;
  z-index: 10;
  margin: 1px;
}

    #messageInput {
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 15px;
    }

    button {
      padding: 10px 12px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      background-color: #007bff;
      color: #fff;
      transition: background-color 0.3s ease;
      margin: 1px;
    }

    #skipButton {
      background-color: #6c757d;
    }

    button:hover {
      opacity: 0.9;
    }

    #hiddenFileInput {
      display: none;
    }

    /* VIDEO CONTAINER */
    #videoContainer {
      width: 100%;
      position: relative;
      overflow: hidden;
      border-radius: 10px;
      margin-bottom: 20px;
    }

    #remoteVideo,
    #localVideo {
      width: 100%;
      height: auto;
      object-fit: cover;
      background: url('R.gif') center center no-repeat;
      background-size: cover;
      border-radius: 10px;
    }

    #localVideo {
      margin-top: 10px;
    }

    /* MOBILE STYLING */
    @media (max-width: 768px) {
      #chatContainer {
        flex-direction: column;
      }

      #rightColumn {
        max-width: 100%;
        height: auto;
        margin-top: 10px;
      }

      #inputContainer {
        position: static;
        margin-top: 10px;
      }

      #remoteVideo {
        border-radius: 10px;
      }

      #localVideo {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 90px;
        height: 70px;
        margin-top: 0;
        z-index: 2;
        border: 2px solid #fff;
      }

      #rightColumn ul {
        display: none;
      }
    }

    /* RULES LIST */
    .rules-list {
      list-style: none;
      padding: 20px;
      background-color: #fff3cd;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
      font-size: 1.1rem;
      line-height: 1.7;
    }

    .rules-list li {
      position: relative;
      padding-left: 30px;
      margin-bottom: 12px;
    }

    .rules-list li::before {
      content: "✔";
      position: absolute;
      left: 0;
      color: #a3cb4c;
      font-weight: bold;
    }

    .rules-list li strong {
      color: #ff0000;
    }

    /* SETUP BOX */
    .setup-wrapper {
  background: #fff;
  border: 1px solid #e0e0e0;
  border-radius: 12px;
  padding: 15px;
}

.setup-heading .emoji {
  font-size: 1.4rem;
  vertical-align: middle;
}

    .setup-description {
      font-size: 1rem;
      color: #333;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(15px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .video-warning {
  background-color: #ffd2d2;
  color: #ff0000;
  font-size: 1.1rem;
  border: 2px solid #ffb3b3;
}

  </style>
</head>

<body>

  <!-- HEADER -->
  <header id="header">
    <div class="header-content">
      <img src="logomain.png" alt="Logo" class="logo" />
    </div>
  </header>

  <!-- NAME MODAL -->
  <div id="nameModal">
    <div class="modal-content">
      <h4>Enter Your Name to Start</h4>
      <input type="text" id="usernameInput" placeholder="Your name" />
      <button id="startTextChatBtn">Start Text Chat</button>
      <button id="startVideoChatBtn">Start Video Chat</button>
    </div>
  </div>

  <!-- CHAT CONTAINER -->
  <div id="chatContainer">
    <div id="leftColumn">
      <div id="videoContainer">
        <video id="remoteVideo" autoplay playsinline></video>
        <video id="localVideo" autoplay muted playsinline></video>
      </div>
    </div>
    <div id="rightColumn">
  <div class="setup-wrapper">
  <p class="setup-description text-secondary fs-5">
    Getting things ready for your video chat experience!<br><br>
    <span class="badge bg-warning text-dark me-2"></span> No inappropriate behavior – keep it respectful and fun.<br>
    <span class="badge bg-info text-dark me-2"></span> Chats may be monitored to keep our community safe.<br><br>
  </p>
</div>



  <div id="messages" class="mb-3"></div>

  <div id="inputContainer" class="d-flex gap-2">
    <button id="skipButton" class="btn btn-warning">Skip</button>
    <input id="messageInput" type="text" placeholder="Type a message..." class="form-control" />
    <button id="sendButton" class="btn btn-primary">Send</button>
    <button id="requestPhotoButton" class="btn btn-secondary">Req Pic</button>
    <input type="file" id="hiddenFileInput" accept="image/*" hidden />
  </div>
</div>

  </div>



  <script>
    let socket;
    let username = '';
    let localStream, peerConnection;
    const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

    // Text Chat Button
    document.getElementById('startTextChatBtn').addEventListener('click', () => {
      const nameInput = document.getElementById('usernameInput').value.trim();
      if (nameInput) {
        username = nameInput;
        document.getElementById('nameModal').style.display = 'none';
        socket = io();
        socket.emit('setName', username);
        initializeChatHandlers();
      }
    });

    // Video Chat Button
    document.getElementById('startVideoChatBtn').addEventListener('click', () => {
      const nameInput = document.getElementById('usernameInput').value.trim();
      if (nameInput) {
        username = nameInput;
        document.getElementById('nameModal').style.display = 'none';
        socket = io();
        socket.emit('setName', username);
        initializeChatHandlers();
        startVideoMode();
      }
    });

    // Start webcam stream only
    function startVideoMode() {
      const videoContainer = document.getElementById('videoContainer');
      if (videoContainer) videoContainer.style.display = 'block';

      navigator.mediaDevices.getUserMedia({ video: true, audio: true })
        .then((stream) => {
          document.getElementById('localVideo').srcObject = stream;
        })
        .catch((err) => {
          alert("Could not access camera or mic.");
          console.error(err);
        });
    }

    function initializeChatHandlers() {
      const videoChatButton = document.getElementById('videoChatButton');
      if (videoChatButton) {
        videoChatButton.addEventListener('click', async () => {
          document.getElementById('videoContainer').style.display = 'block';
          localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
          document.getElementById('localVideo').srcObject = localStream;

          peerConnection = new RTCPeerConnection(config);

          localStream.getTracks().forEach(track => {
            peerConnection.addTrack(track, localStream);
          });

          peerConnection.ontrack = (event) => {
            document.getElementById('remoteVideo').srcObject = event.streams[0];
          };

          peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
              socket.emit('iceCandidate', event.candidate);
            }
          };

          const offer = await peerConnection.createOffer();
          await peerConnection.setLocalDescription(offer);
          socket.emit('videoOffer', offer);
        });
      }

      // WebRTC signaling
      socket.on('videoOffer', async (offer) => {
        document.getElementById('videoContainer').style.display = 'block';
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        document.getElementById('localVideo').srcObject = localStream;

        peerConnection = new RTCPeerConnection(config);

        localStream.getTracks().forEach(track => {
          peerConnection.addTrack(track, localStream);
        });

        peerConnection.ontrack = (event) => {
          document.getElementById('remoteVideo').srcObject = event.streams[0];
        };

        peerConnection.onicecandidate = (event) => {
          if (event.candidate) {
            socket.emit('iceCandidate', event.candidate);
          }
        };

        await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        socket.emit('videoAnswer', answer);
      });

      socket.on('videoAnswer', async (answer) => {
        await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
      });

      socket.on('iceCandidate', async (candidate) => {
        if (peerConnection) {
          await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
        }
      });

      // Photo Request
      document.getElementById('requestPhotoButton').addEventListener('click', () => {
        socket.emit('requestPhoto');
        appendMessage('You requested a photo from your partner', 'system');
      });

      socket.on('photoRequest', () => {
        const messagesDiv = document.getElementById('messages');
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message', 'system-message');

        const text = document.createTextNode('Your partner requested a photo: ');
        const link = document.createElement('span');
        link.textContent = 'Click here to send';
        link.style.color = '#a30000';
        link.style.cursor = 'pointer';
        link.style.textDecoration = 'underline';
        link.onclick = () => document.getElementById('hiddenFileInput').click();

        messageDiv.appendChild(text);
        messageDiv.appendChild(link);
        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      });

      // Image Sending
      document.getElementById('hiddenFileInput').addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (file && file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = function (event) {
            socket.emit('sendImage', event.target.result);
            appendImage(event.target.result, 'user');
          };
          reader.readAsDataURL(file);
        }
      });

      socket.on('receiveImage', (imageData) => {
        appendImage(imageData, 'partner');
      });

      // Chat Events
      socket.on('waiting', () => {
        appendMessage('Keep the Chat Clean and do not share absurd pictures. Waiting for a partner...', 'system');
        document.getElementById('sendButton').disabled = true;
      });

      socket.on('partnerFound', () => {
        appendMessage('You are now connected with a partner!', 'system');
        document.getElementById('sendButton').disabled = false;
      });

      socket.on('message', ({ text, name }) => {
        appendMessage(`${name || 'Partner'}: ${text}`, 'partner');
      });

      socket.on('partnerDisconnected', () => {
        appendMessage('Your partner has disconnected.', 'system');
        document.getElementById('sendButton').disabled = true;
      });

      document.getElementById('sendButton').addEventListener('click', () => {
        const messageInput = document.getElementById('messageInput');
        const message = messageInput.value.trim();
        if (message) {
          appendMessage(message, 'user');
          socket.emit('sendMessage', { text: message, name: username });
          messageInput.value = '';
        }
      });

      document.getElementById('skipButton').addEventListener('click', () => {
        socket.emit('skip');
        appendMessage('You have skipped to find a new partner.', 'system');
      });

      // Style for system messages
      const style = document.createElement('style');
      style.textContent = `
        .system-message {
            text-align: center;
            color: red;
            font-weight: bold;
            margin: 10px 0;
        }
        .system-message span:hover {
            color: #ff0000;
            text-decoration: underline;
        }
    `;
      document.head.appendChild(style);
    }

    // Message output
    function appendMessage(message, type) {
      const messagesDiv = document.getElementById('messages');
      const messageDiv = document.createElement('div');
      messageDiv.classList.add('message');
      messageDiv.classList.add(
        type === 'user' ? 'user-message' :
          type === 'partner' ? 'partner-message' :
            'system-message'
      );
      messageDiv.textContent = message;
      messagesDiv.appendChild(messageDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // Image output
    function appendImage(imageData, type) {
      const messagesDiv = document.getElementById('messages');
      const container = document.createElement('div');
      container.classList.add('message', type === 'user' ? 'user-message' : 'partner-message');

      const img = document.createElement('img');
      img.src = imageData;
      img.style.maxWidth = '200px';
      img.style.borderRadius = '10px';
      img.style.margin = '5px 0';

      container.appendChild(img);
      messagesDiv.appendChild(container);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
  </script>
  <script>

    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    const nameModal = document.getElementById('nameModal');
    const startVideoChatBtn = document.getElementById('startVideoChatBtn');

    startVideoChatBtn.addEventListener('click', async () => {
      nameModal.style.display = 'none';
      document.getElementById("videoContainer").style.display = "block";

      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      localVideo.srcObject = localStream;

      peerConnection = new RTCPeerConnection(config);

      // Send tracks
      localStream.getTracks().forEach(track => {
        peerConnection.addTrack(track, localStream);
      });

      // Receive tracks
      peerConnection.ontrack = event => {
        console.log('Received remote stream');
        remoteVideo.srcObject = event.streams[0];
      };

      // ICE candidates
      peerConnection.onicecandidate = event => {
        if (event.candidate) {
          socket.emit('iceCandidate', event.candidate);
        }
      };

      // Partner found
      socket.on('partnerFound', async () => {
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        socket.emit('videoOffer', offer);
      });

      // Receive offer
      socket.on('videoOffer', async offer => {
        if (!peerConnection) {
          peerConnection = new RTCPeerConnection(config);
          localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

          peerConnection.ontrack = event => {
            console.log('Received remote stream from offer');
            remoteVideo.srcObject = event.streams[0];
          };

          peerConnection.onicecandidate = event => {
            if (event.candidate) {
              socket.emit('iceCandidate', event.candidate);
            }
          };
        }

        await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        socket.emit('videoAnswer', answer);
      });

      // Receive answer
      socket.on('videoAnswer', async answer => {
        await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
      });

      // Receive ICE
      socket.on('iceCandidate', async candidate => {
        try {
          await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
        } catch (err) {
          console.error('Error adding received ICE candidate', err);
        }
      });
    });
  </script>



</body>

</html>